<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEM Data Validator</title>
    <style>
        body { font-family: system-ui; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #333; text-align: center; }
        .controls { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: end; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.9rem; color: #666; }
        select, input, button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #667eea; color: white; border: none; cursor: pointer; }
        button:hover { background: #5a67d8; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: white; padding: 20px; border-radius: 8px; }
        .panel h2 { margin: 0 0 15px 0; font-size: 1.2rem; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f8f8; padding: 8px; text-align: left; font-size: 0.9rem; }
        td { padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .match { background: #e8f5e9; }
        .mismatch { background: #ffebee; }
        .summary { background: white; padding: 20px; border-radius: 8px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat { padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.8rem; color: #666; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { color: #d32f2f; padding: 10px; background: #ffebee; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üîå NEM Data Validation</h1>
    
    <div class="controls">
        <div class="control-group">
            <label>Region</label>
            <select id="region">
                <option value="NSW1">NSW</option>
                <option value="QLD1">QLD</option>
                <option value="SA1">SA</option>
                <option value="TAS1">TAS</option>
                <option value="VIC1" selected>VIC</option>
            </select>
        </div>
        <div class="control-group">
            <label>Date</label>
            <input type="date" id="date">
        </div>
        <button onclick="validate()">Validate</button>
    </div>
    
    <div class="grid">
        <div class="panel">
            <h2>Our Harvester</h2>
            <div id="harvester"><div class="loading">Ready</div></div>
        </div>
        <div class="panel">
            <h2>OpenNEM API</h2>
            <div id="opennem"><div class="loading">Ready</div></div>
        </div>
    </div>
    
    <div class="summary">
        <h2>Validation Summary</h2>
        <div id="summary">Select date and region to validate</div>
    </div>
    
    <script>
        document.getElementById('date').value = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        
        async function validate() {
            const region = document.getElementById('region').value;
            const date = document.getElementById('date').value;
            
            document.getElementById('harvester').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('opennem').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('summary').innerHTML = '<div class="loading">Comparing...</div>';
            
            try {
                // Fetch both sources
                const [harvesterResp, opennemResp] = await Promise.all([
                    fetch(`/api/day?region=${region}&date=${date}`),
                    fetch(`https://api.opennem.org.au/v3/price/${region.toLowerCase()}?date=${date}`)
                ]);
                
                const harvesterData = await harvesterResp.json();
                let opennemData = null;
                
                try {
                    opennemData = await opennemResp.json();
                } catch (e) {
                    document.getElementById('opennem').innerHTML = '<div class="error">OpenNEM API error</div>';
                }
                
                // Display harvester data
                if (harvesterData.success && harvesterData.data) {
                    const sample = harvesterData.data.filter((_, i) => i % 12 === 0).slice(0, 20);
                    let html = '<table><tr><th>Time</th><th>Price</th></tr>';
                    sample.forEach(d => {
                        html += `<tr><td>${d.time}</td><td>$${d.price.toFixed(2)}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('harvester').innerHTML = html;
                } else {
                    document.getElementById('harvester').innerHTML = '<div class="error">No data</div>';
                }
                
                // Display OpenNEM data
                if (opennemData && opennemData.data && opennemData.data[0]) {
                    const prices = opennemData.data[0].history.data;
                    const interval = opennemData.data[0].history.interval;
                    const start = new Date(opennemData.data[0].history.start);
                    
                    let html = '<table><tr><th>Time</th><th>Price</th></tr>';
                    prices.filter((p, i) => p !== null && i % 12 === 0).slice(0, 20).forEach((price, idx) => {
                        const time = new Date(start.getTime() + (idx * 12 * 5 * 60000));
                        const timeStr = `${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
                        html += `<tr><td>${timeStr}</td><td>$${price.toFixed(2)}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('opennem').innerHTML = html;
                }
                
                // Compare data
                if (harvesterData.success && opennemData && opennemData.data) {
                    const harvesterMap = new Map(harvesterData.data.map(d => [d.time, d.price]));
                    const opennemPrices = opennemData.data[0].history.data;
                    const start = new Date(opennemData.data[0].history.start);
                    
                    let matches = 0, total = 0, maxDiff = 0;
                    
                    opennemPrices.forEach((price, idx) => {
                        if (price !== null) {
                            const time = new Date(start.getTime() + (idx * 5 * 60000));
                            const timeStr = `${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
                            
                            if (harvesterMap.has(timeStr)) {
                                total++;
                                const diff = Math.abs(harvesterMap.get(timeStr) - price);
                                if (diff < 0.01) matches++;
                                maxDiff = Math.max(maxDiff, diff);
                            }
                        }
                    });
                    
                    const matchRate = total > 0 ? (matches / total * 100) : 0;
                    
                    document.getElementById('summary').innerHTML = `
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-value" style="color: ${matchRate > 99 ? '#4caf50' : '#ff9800'}">${matchRate.toFixed(1)}%</div>
                                <div class="stat-label">Match Rate</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${total}</div>
                                <div class="stat-label">Points Compared</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${harvesterData.data.length}</div>
                                <div class="stat-label">Harvester Points</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">$${maxDiff.toFixed(2)}</div>
                                <div class="stat-label">Max Difference</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: ${matchRate > 99 ? '#4caf50' : '#666'}">
                            ${matchRate === 100 ? '‚úÖ Perfect match!' : matchRate > 99 ? '‚úÖ Excellent match!' : '‚ö†Ô∏è Some differences detected'}
                        </p>
                    `;
                }
                
            } catch (error) {
                document.getElementById('summary').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>